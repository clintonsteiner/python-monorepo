name: Publish

on:
  push:
    tags:
      - "v*"
      - "*-v*"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version-file: pyproject.toml

      - name: Sync dependencies
        run: uv sync --all-groups

      - name: Run tests
        run: uv run pytest packages -v

  determine-packages:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Determine which packages to publish
        id: set-matrix
        run: |
          TAG=${{ github.ref_name }}

          # Get all package names from pyproject.toml files
          ALL_PACKAGES=$(find packages/*/pyproject.toml -exec grep -h '^name = ' {} \; | sed 's/name = "\(.*\)"/\1/' | jq -R . | jq -s .)

          # Determine which packages to publish based on tag
          if [[ $TAG == v* ]] && [[ $TAG != *-v* ]]; then
            # Tag format: v0.1.0 - publish all packages
            MATRIX=$ALL_PACKAGES
          else
            # Tag format: package-name-v0.1.0 - extract package name and publish only that one
            PACKAGE_NAME=$(echo "$TAG" | sed 's/-v[0-9.]*$//')

            # Verify the package exists
            if grep -r "name = \"$PACKAGE_NAME\"" packages/*/pyproject.toml > /dev/null; then
              MATRIX=$(echo "$PACKAGE_NAME" | jq -R . | jq -s .)
            else
              echo "Package $PACKAGE_NAME not found in any pyproject.toml"
              exit 1
            fi
          fi

          echo "matrix=$(echo $MATRIX | jq -c .)" >> $GITHUB_OUTPUT

  publish:
    needs: [test, determine-packages]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: ${{ fromJson(needs.determine-packages.outputs.matrix) }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version-file: pyproject.toml

      - name: Sync dependencies
        run: uv sync

      - name: Find package directory
        id: find-dir
        run: |
          PACKAGE="${{ matrix.package }}"
          # Dynamically find the package directory by searching for the package name in pyproject.toml
          DIR=$(grep -r "name = \"$PACKAGE\"" packages/*/pyproject.toml | head -1 | cut -d: -f1 | xargs dirname)

          if [ -z "$DIR" ]; then
            echo "Package $PACKAGE not found in any pyproject.toml"
            exit 1
          fi

          echo "dir=$DIR" >> $GITHUB_OUTPUT

      - name: Build ${{ matrix.package }}
        run: uv build ${{ steps.find-dir.outputs.dir }} --out-dir ${{ steps.find-dir.outputs.dir }}/dist

      - name: Publish ${{ matrix.package }} to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: ${{ steps.find-dir.outputs.dir }}/dist
