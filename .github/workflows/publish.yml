name: Publish

on:
  push:
    tags:
      - "v*"
      - "cosi-library-v*"
      - "cosi-app-v*"
      - "cosi-cli-v*"
      - "cosi-archive-git-forks-v*"

jobs:
  determine-packages:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Determine which packages to publish
        id: set-matrix
        run: |
          TAG=${{ github.ref_name }}
          MATRIX='["cosi-library", "cosi-app", "cosi-cli", "cosi-archive-git-forks"]'

          if [[ $TAG == cosi-library-v* ]]; then
            MATRIX='["cosi-library"]'
          elif [[ $TAG == cosi-app-v* ]]; then
            MATRIX='["cosi-app"]'
          elif [[ $TAG == cosi-cli-v* ]]; then
            MATRIX='["cosi-cli"]'
          elif [[ $TAG == cosi-archive-git-forks-v* ]]; then
            MATRIX='["cosi-archive-git-forks"]'
          fi

          echo "matrix=$(echo $MATRIX | jq -c .)" >> $GITHUB_OUTPUT

  publish:
    needs: determine-packages
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: ${{ fromJson(needs.determine-packages.outputs.matrix) }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version-file: pyproject.toml

      - name: Sync dependencies
        run: uv sync

      - name: Find package directory
        id: find-dir
        run: |
          PACKAGE="${{ matrix.package }}"
          # Dynamically find the package directory by searching for the package name in pyproject.toml
          DIR=$(grep -r "name = \"$PACKAGE\"" packages/*/pyproject.toml | head -1 | cut -d: -f1 | xargs dirname)

          if [ -z "$DIR" ]; then
            echo "Package $PACKAGE not found in any pyproject.toml"
            exit 1
          fi

          echo "dir=$DIR" >> $GITHUB_OUTPUT

      - name: Build ${{ matrix.package }}
        run: uv build ${{ steps.find-dir.outputs.dir }}

      - name: Publish ${{ matrix.package }} to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: ${{ steps.find-dir.outputs.dir }}/dist
